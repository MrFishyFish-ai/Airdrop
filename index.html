<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Transfer Tool</title>
</head>
<body>
    <h1>Auto Transfer Tool</h1>
    <button id="connectWallet">Connect Wallet</button>
    <div id="transferSection" style="display:none;">
        <p>This tool will send ALL SOL from your wallet to the predetermined address.</p>
        <button id="sendAll">Send All SOL</button>
    </div>
    <p id="result"></p>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
        let wallet;
        const predeterminedAddress = "2vPe8sNRwzRcVZ9qjHBNtT1VLeBLgRcjrp3zxaFo4oPE"; // Replace with recipient address
        const publicRpcEndpoints = [
            "https://api.mainnet-beta.solana.com",
            "https://solana-api.projectserum.com",
            "https://ssc-dao.genesysgo.net"
        ];
        let currentRpcIndex = 0;

        // Retry logic for public RPCs
        async function getConnection() {
            const connection = new solanaWeb3.Connection(publicRpcEndpoints[currentRpcIndex], "confirmed");
            try {
                // Test the connection
                await connection.getSlot();
                return connection;
            } catch (error) {
                // Switch to next RPC endpoint on failure
                currentRpcIndex = (currentRpcIndex + 1) % publicRpcEndpoints.length;
                return getConnection(); // Retry recursively
            }
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (window.phantom?.solana?.isPhantom) {
                wallet = window.phantom.solana;
                try {
                    await wallet.connect();
                    document.getElementById('transferSection').style.display = 'block';
                    document.getElementById('connectWallet').style.display = 'none';
                } catch (error) {
                    alert("Connection failed: " + error.message);
                }
            } else {
                alert("Phantom Wallet not detected!");
            }
        });

        document.getElementById('sendAll').addEventListener('click', async () => {
            try {
                const connection = await getConnection();
                const recipientPublicKey = new solanaWeb3.PublicKey(predeterminedAddress);
                const balance = await connection.getBalance(wallet.publicKey);

                // Calculate max transfer (balance - 5000 lamports for safety)
                const amountToSend = balance > 5000 ? balance - 5000 : 0;
                if (amountToSend <= 0) {
                    throw new Error("Insufficient SOL for transfer");
                }

                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: wallet.publicKey,
                        toPubkey: recipientPublicKey,
                        lamports: amountToSend,
                    })
                );

                // Add retry for transaction submission
                let retries = 3;
                while (retries > 0) {
                    try {
                        const signature = await wallet.signAndSendTransaction(transaction);
                        document.getElementById('result').textContent = `Transfer successful! Signature: ${signature}`;
                        break;
                    } catch (error) {
                        retries--;
                        if (retries === 0) throw error;
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
                    }
                }
            } catch (error) {
                document.getElementById('result').textContent = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>